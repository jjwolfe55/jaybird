CREATE VIEW team_results_games AS 
WITH per_game_mri AS (
SELECT 
a.team_id AS team_id,
a.season_id AS season_id,
a.mri_w/a.g AS mri_w,
a.mri_l/a.g AS mri_l,
a.mri_w_pct AS mri_w_pct
FROM mri_team_standings AS a
)
, game_log AS (
SELECT 
a.game_id,
b.franchise_id AS franchise,
a.h_team_id AS team,
b.nickname  AS team_nickname,
b.league_id AS league,
b.division_id AS division,
e.franchise_id AS opponent_franchise,
c.v_team_id AS opponent,
e.nickname AS opponent_nickname,
e.league_id AS opponent_league,
e.division_id AS opponent_division,
a.season_id AS season,
a.game_type,
a.game_date,
a.start_time,
"Home" AS location,
d.ballpark_name AS ballpark,
a.precipitation,
a.sky_condition,
a.temp,
a.wind_direction,
a.wind_speed,
a.attendance,
a.game_time AS game_duration,
(CASE WHEN a.winning_team = a.h_team_id THEN 'W' 
WHEN a.winning_team  = '' THEN 'T' ELSE 'L' END) AS  result,
a.h_team_runs AS runs,
a.v_team_runs AS runs_against,
m.mri_w,
m.mri_l,
m.mri_w_pct
FROM lines_games AS a
INNER JOIN lookup_team_history AS b
ON a.h_team_id = b.team_id 
AND a.season_id BETWEEN b.first_season AND b.last_season
INNER JOIN lines_games AS c
ON a.game_id = c.game_id
LEFT JOIN lookup_ballparks AS d
ON a.ballpark = d.ballpark
INNER JOIN lookup_team_history AS e
ON a.v_team_id = e.team_id
AND a.season_id BETWEEN e.first_season AND e.last_season
LEFT JOIN per_game_mri AS m
ON a.h_team_id = m.team_id AND a.season_id = m.season_id
UNION ALL
SELECT 
a.game_id,
b.franchise_id AS franchise,
a.v_team_id AS team,
b.nickname  AS team_nickname,
b.league_id AS league,
b.division_id AS division,
e.franchise_id AS opponent_franchise,
c.h_team_id AS opponent,
e.nickname AS opponent_nickname,
e.league_id AS opponent_league,
e.division_id AS opponent_division,
a.season_id AS season,
a.game_type,
a.game_date,
a.start_time,
"Away" AS location,
d.ballpark_name AS ballpark,
a.precipitation,
a.sky_condition,
a.temp,
a.wind_direction,
a.wind_speed,
a.attendance,
a.game_time AS game_duration,
(CASE WHEN a.winning_team = a.v_team_id THEN 'W' 
WHEN a.winning_team  = '' THEN 'T' ELSE 'L' END) AS  result,
a.v_team_runs AS runs,
a.h_team_runs AS runs_against,
m.mri_w,
m.mri_l,
m.mri_w_pct
FROM lines_games AS a
INNER JOIN lookup_team_history AS b
ON a.v_team_id = b.team_id 
AND a.season_id BETWEEN b.first_season AND b.last_season
INNER JOIN lines_games AS c
ON a.game_id = c.game_id
LEFT JOIN lookup_ballparks AS d
ON a.ballpark = d.ballpark
INNER JOIN lookup_team_history AS e
ON a.h_team_id = e.team_id
AND a.season_id BETWEEN e.first_season AND e.last_season
LEFT JOIN per_game_mri AS m
ON a.v_team_id = m.team_id AND a.season_id = m.season_id
)
SELECT *, rank() OVER (PARTITION BY team, season ORDER BY game_date ASC) AS game_num
FROM game_log
WHERE  team IN (
"ANA",
"ARI",
"ATL",
"BAL",
"BFN",
"BLA",
"BLN",
"BOS",
"BRO",
"BSN",
"CAL",
"CHA",
"CHN",
"CIN",
"CL2",
"CL4",
"CLE",
"CN1",
"CN4",
"COL",
"DET",
"DTN",
"FLO",
"HAR",
"HOU",
"IN1",
"IN3",
"KC1",
"KCA",
"KCN",
"LAA",
"LAN",
"LS1",
"LS3",
"MIA",
"MIL",
"MIN",
"ML2",
"MLA",
"MLN",
"MON",
"NY1",
"NY3",
"NYA",
"NYN",
"OAK",
"PHA",
"PHI",
"PHN",
"PIT",
"PRO",
"SDN",
"SE1",
"SEA",
"SFN",
"SL3",
"SL5",
"SLA",
"SLN",
"SR1",
"TBA",
"TEX",
"TOR",
"TRN",
"WAS",
"WOR",
"WS1",
"WS2",
"WS8",
"WSN")
AND 
opponent IN (
"ANA",
"ARI",
"ATL",
"BAL",
"BFN",
"BLA",
"BLN",
"BOS",
"BRO",
"BSN",
"CAL",
"CHA",
"CHN",
"CIN",
"CL2",
"CL4",
"CLE",
"CN1",
"CN4",
"COL",
"DET",
"DTN",
"FLO",
"HAR",
"HOU",
"IN1",
"IN3",
"KC1",
"KCA",
"KCN",
"LAA",
"LAN",
"LS1",
"LS3",
"MIA",
"MIL",
"MIN",
"ML2",
"MLA",
"MLN",
"MON",
"NY1",
"NY3",
"NYA",
"NYN",
"OAK",
"PHA",
"PHI",
"PHN",
"PIT",
"PRO",
"SDN",
"SE1",
"SEA",
"SFN",
"SL3",
"SL5",
"SLA",
"SLN",
"SR1",
"TBA",
"TEX",
"TOR",
"TRN",
"WAS",
"WOR",
"WS1",
"WS2",
"WS8",
"WSN")
ORDER BY  team ASC, season DESC, game_date ASC;

CREATE VIEW team_results_standings AS 
SELECT 
c.franchise_id AS franchise,
a.team_id AS team,
c.nickname AS team_nickname,
c.league_id AS league,
c.division_id AS division, 
a.season_id AS season,
a.g,
a.w,
a.l,
a.t,
a.win_pct AS w_pct,
b.mri_w,
b.mri_l,
b.mri_w_pct,
a.h_g,
a.h_w,
a.h_l,
a.h_t,
a.h_win_pct AS h_w_pct,
a.v_g,
a.v_w,
a.v_l,
a.v_t,
a.v_win_pct AS v_w_pct
FROM standard_standings AS a
LEFT JOIN mri_team_standings AS b
ON a.team_id = b.team_id AND a.season_id = b.season_id
LEFT JOIN lookup_team_history AS c
ON a.team_id = c.team_id AND 
a.season_id BETWEEN c.first_season AND c.last_season;

CREATE VIEW team_offense_batting AS
SELECT 
d.franchise_id AS franchise,
a.team_id AS team,
d.nickname AS team_nickname,
d.league_id AS league,
d.division_id AS division,
a.season_id AS season,
COUNT(a.player_id) AS batters,
ROUND(AVG(a.age),1) AS age,
e.g AS g,
SUM(a.b_pa) AS pa,
SUM(a.b_ab) AS ab,
SUM(a.b_r) AS r,
SUM(a.b_h) AS h,
SUM(a.b_s) AS 1b,
SUM(a.b_d) AS 2b,
SUM(a.b_t) AS 3b,
SUM(a.b_hr) AS hr,
SUM(a.b_rbi) AS rbi,
SUM(a.b_sh) AS sh,
SUM(a.b_sf) AS sf,
SUM(a.b_hbp) AS hbp,
SUM(a.b_bb) AS bb,
SUM(a.b_ibb) AS ibb,
SUM(a.b_so) AS so,
SUM(a.b_gdp) AS gdp,
SUM(a.b_ci) AS ci,
SUM(a.b_roe) AS roe,
ROUND((CASE WHEN SUM(a.b_ab) = 0 THEN NULL ELSE COALESCE((SUM(a.b_h))/(NULLIF(SUM(a.b_ab),0)),0) END),3) AS avg,
ROUND(((SUM(a.b_h)+SUM(a.b_bb)+SUM(a.b_hbp))/((SUM(a.b_ab)+SUM(a.b_bb)+SUM(a.b_hbp)+SUM(a.b_sf)))),3) AS obp,
ROUND(((SUM(a.b_s)+SUM(a.b_d)+SUM(a.b_d)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr))/SUM(a.b_ab)),3) AS slg,
ROUND(((SUM(a.b_h)+SUM(a.b_bb)+SUM(a.b_hbp))/((SUM(a.b_ab)+SUM(a.b_bb)+SUM(a.b_hbp)+SUM(a.b_sf)))) + ((SUM(a.b_s)+SUM(a.b_d)+SUM(a.b_d)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr))/SUM(a.b_ab)),3) AS ops,
ROUND(((SUM(a.b_s)+SUM(a.b_d)+SUM(a.b_d)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_t)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr)+SUM(a.b_hr))/SUM(a.b_ab)) - (CASE WHEN SUM(a.b_ab) = 0 THEN NULL ELSE COALESCE((SUM(a.b_h))/(NULLIF(SUM(a.b_ab),0)),0) END),3)  AS iso,
ROUND(((SUM(a.b_bb)+SUM(a.b_ibb))/SUM(a.b_pa)),2) AS bb_rate,
ROUND((SUM(a.b_so)/SUM(a.b_pa)),2) AS so_rate,
SUM(c.mri_batting_rc) AS mri_rc,
SUM(c.mri_batting_raa) AS mri_raa,
SUM(c.mri_batting_waa) AS mri_waa,
SUM(c.mri_batting_war) AS mri_war
FROM standard_batting AS a
INNER JOIN rate_batting AS b
ON a.player_id = b.player_id AND a.team_id = b.team_id AND a.season_id = b.season_id
LEFT JOIN mri_creating_batting AS c
ON a.player_id = c.player_id AND a.team_id = c.team_id AND a.season_id = c.season_id
LEFT JOIN lookup_team_history AS d
ON a.team_id = d.team_id AND 
a.season_id BETWEEN d.first_season AND d.last_season
INNER JOIN standard_standings AS e
ON a.team_id = e.team_id AND a.season_id = e.season_id
GROUP BY a.team_id,a.season_id;

CREATE VIEW team_offense_baserunning AS
SELECT 
d.franchise_id AS franchise,
a.team_id AS team,
d.nickname AS team_nickname,
d.league_id AS league,
d.division_id AS division,
a.season_id AS season,
COUNT(a.player_id) AS baserunners,
ROUND(AVG(a.age),1) AS age,
e.g AS g,
SUM(a.b_sb) AS sb,
SUM(a.b_cs) AS cs,
ROUND(SUM(a.b_sb)/(SUM(b_sb)+SUM(b_cs)),2) AS sb_pct,
SUM(c.mri_c_baserunning_rc) AS mri_c_baserunning_rc,
SUM(c.mri_c_baserunning_raa) AS mri_c_baserunning_raa,
SUM(c.mri_c_baserunning_waa) AS mri_c_baserunning_waa,
SUM(c.mri_c_baserunning_war) AS mri_c_baserunning_war
FROM standard_batting AS a
INNER JOIN rate_c_baserunning AS b
ON a.player_id = b.player_id AND a.team_id = b.team_id AND a.season_id = b.season_id
LEFT JOIN mri_creating_baserunning AS c
ON a.player_id = c.player_id AND a.team_id = c.team_id AND a.season_id = c.season_id
LEFT JOIN lookup_team_history AS d
ON a.team_id = d.team_id AND 
a.season_id BETWEEN d.first_season AND d.last_season
INNER JOIN standard_standings AS e
ON a.team_id = e.team_id AND a.season_id = e.season_id
GROUP BY 
a.team_id,
a.season_id;

CREATE VIEW team_defense_pitching AS
SELECT 
 d.franchise_id AS franchise,
 a.team_id AS team,
 d.nickname AS team_nickname,
 d.league_id AS league,
 d.division_id AS division,
 a.season_id AS season,
 COUNT(a.player_id) AS pitchers,
 ROUND(AVG(a.age),1) AS age,
 e.g AS g, 
 SUM(a.p_cg) AS cg,
 SUM(a.p_ip) AS ip,
 SUM(a.p_bf) AS bf,
 SUM(a.p_h) AS h,
 SUM(a.p_s) AS 1b,
 SUM(a.p_d) AS 2b,
 SUM(a.p_t) AS 3b,
 SUM(a.p_hr) AS hr,
 SUM(a.p_r) AS r,
 SUM(a.p_er) AS er,
 SUM(a.p_bb) AS bb,
 SUM(a.p_ibb) AS ibb,
 SUM(a.p_so) AS so,
 SUM(a.p_hbp) AS hbp,
 SUM(a.p_sh) AS sh,
 SUM(a.p_sf) AS sf, 
 SUM(a.p_sb) AS sb,
 SUM(a.p_cs) AS cs,
 SUM(a.p_bk) AS bk,
 SUM(a.p_wp) AS wp,
 SUM(a.p_pb) AS pb,
 SUM(a.p_wins) AS wins,
 SUM(a.p_losses) AS losses,
 SUM(a.p_saves) AS saves,
 ROUND((CASE WHEN (SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb)) = 0 THEN NULL ELSE COALESCE((SUM(a.p_h))/(NULLIF((SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb)),0)),0) END),3) AS avg,
ROUND(((SUM(a.p_h)+SUM(a.p_bb)+SUM(a.p_hbp))/(((SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb))+SUM(a.p_bb)+SUM(a.p_hbp)+SUM(a.p_sf)))),3) AS obp,
ROUND(((SUM(a.p_s)+SUM(a.p_d)+SUM(a.p_d)+SUM(a.p_t)+SUM(a.p_t)+SUM(a.p_t)+SUM(a.p_hr)+SUM(a.p_hr)+SUM(a.p_hr)+SUM(a.p_hr))/(SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb))),3) AS slg,
ROUND((((SUM(a.p_h)+SUM(a.p_bb)+SUM(a.p_hbp))/((SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb))+SUM(a.p_bb)+SUM(a.p_hbp)+SUM(a.p_sf))) + ((SUM(a.p_s)+SUM(a.p_d)+SUM(a.p_d)+SUM(a.p_t)+SUM(a.p_t)+SUM(a.p_t)+SUM(a.p_hr)+SUM(a.p_hr)+SUM(a.p_hr)+SUM(a.p_hr))/(SUM(a.p_bf)-SUM(a.p_sf)-SUM(a.p_sh)-SUM(a.p_bb)-SUM(a.p_hbp)-SUM(a.p_ibb)))),3) AS ops,
ROUND(((SUM(a.p_er)*9)/SUM(a.p_ip)),2) AS era,
ROUND(((SUM(a.p_bb)+SUM(a.p_ibb))/SUM(a.p_bf)),2) AS bb_rate,
ROUND((SUM(a.p_so)/SUM(a.p_bf)),2) AS so_rate,
SUM(c.mri_pitching_rc) AS mri_rc,
SUM(c.mri_pitching_raa) AS mri_raa,
SUM(c.mri_pitching_waa) AS mri_waa,
SUM(c.mri_pitching_war) AS mri_war
FROM standard_pitching AS a
INNER JOIN rate_pitching AS b
ON a.player_id = b.player_id AND a.team_id = b.team_id AND a.season_id = b.season_id
LEFT JOIN mri_preventing_pitching AS c
ON a.player_id = c.player_id AND a.team_id = c.team_id AND a.season_id = c.season_id
LEFT JOIN lookup_team_history AS d
ON a.team_id = d.team_id AND 
a.season_id BETWEEN d.first_season AND d.last_season
INNER JOIN standard_standings AS e
ON a.team_id = e.team_id AND a.season_id = e.season_id
GROUP BY a.team_id,a.season_id;

CREATE VIEW team_defense_fielding AS
SELECT 
 d.franchise_id AS franchise,
 a.team_id AS team,
 d.nickname AS team_nickname,
 d.league_id AS league,
 d.division_id AS division,
 a.season_id AS season,
 COUNT(a.player_id) AS fielders,
 ROUND(AVG(a.age),1) AS age,
 e.g AS g,
 SUM(a.d_inn) AS inn,
 SUM(a.d_po) AS po,
 SUM(a.d_a) AS a,
 SUM(a.d_e) AS e,
 SUM(a.d_dp) AS dp,
 SUM(a.d_tp) AS tp,
 SUM(a.d_pb) AS pb,
 SUM(a.d_wp) AS wp,
 ROUND(((SUM(a.d_po)+SUM(a.d_a))/(SUM(a.d_po)+SUM(a.d_a)+SUM(a.d_e))),3) AS f_pct,
 ROUND(((SUM(a.d_po)+SUM(a.d_a))/SUM(a.d_inn)),2) AS play_pct,
 ROUND((((SUM(a.d_a))+(SUM(a.d_po))+(SUM(a.d_e)))/(SUM(a.d_inn))),3) AS mri_range,
 SUM(c.mri_fielding_rc) AS mri_rc,
 SUM(c.mri_fielding_raa) AS mri_raa,
 SUM(c.mri_fielding_waa) AS mri_waa,
 SUM(c.mri_fielding_war) AS mri_war
FROM standard_fielding AS a
INNER JOIN rate_fielding AS b
ON a.player_id = b.player_id AND a.team_id = b.team_id AND a.season_id = b.season_id AND a.d_pos = b.d_pos
LEFT JOIN mri_preventing_fielding AS c
ON a.player_id = c.player_id AND a.team_id = c.team_id AND a.season_id = c.season_id AND a.d_pos = c.d_pos
LEFT JOIN lookup_team_history AS d
ON a.team_id = d.team_id AND 
a.season_id BETWEEN d.first_season AND d.last_season
INNER JOIN standard_standings AS e
ON a.team_id = e.team_id AND a.season_id = e.season_id
GROUP BY a.team_id,a.season_id;
